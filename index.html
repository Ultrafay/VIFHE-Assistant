<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VIFHE Bot</title>
  <meta name="color-scheme" content="dark"/>

  <!-- Markdown + sanitize (for clean blue links, headings, lists, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --bg-grad1: rgba(125,211,252,.10);
      --bg-grad2: rgba(167,139,250,.10);
      --panel:#0e1530;
      --panel-2:#0b1230;
      --text:#eaf0ff;
      --muted:#a3acc7;
      --border:rgba(255,255,255,.08);
      --ring:rgba(124,197,255,.25);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--text);
      font:16px/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(1000px 700px at -15% -10%, var(--bg-grad1), transparent 60%),
        radial-gradient(900px 600px at 115% 0%, var(--bg-grad2), transparent 55%),
        var(--bg);
      display:grid; grid-template-rows:auto 1fr;
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(130%) blur(10px);
      background:linear-gradient(180deg, rgba(10,16,36,.7), rgba(10,16,36,.35));
      border-bottom:1px solid var(--border);
    }
    .container{ width:min(980px,92vw); margin:0 auto; padding:16px 0; display:flex; align-items:center; gap:12px; }
    .logo{
      width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#0b1020; font-weight:900;
      box-shadow:var(--shadow);
      font-size:20px;
    }
    .brand h1{ margin:0; font-size:22px; letter-spacing:.2px }
    .brand p{ margin:4px 0 0; font-size:13px; color:var(--muted) }

    /* Chat card */
    .card{
      width:min(980px,92vw); margin:22px auto;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      display:grid; grid-template-rows:auto 1fr auto; overflow:hidden;
    }
    .card-head{
      padding:14px 16px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border);
    }
    .status-dot{ width:8px; height:8px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.15) }
    .card-head .muted{ color:var(--muted); font-size:13px }

    /* Messages area */
    #messages{
      padding:18px 14px; overflow:auto; scroll-behavior:smooth;
      background:
        radial-gradient(900px 700px at 50% -30%, rgba(255,255,255,.02), transparent 60%),
        radial-gradient(700px 600px at 0% 110%, rgba(125,211,252,.06), transparent 55%),
        radial-gradient(700px 600px at 100% 110%, rgba(167,139,250,.06), transparent 55%);
    }
    .row{ display:flex; gap:10px; margin:12px 0; align-items:flex-end; }
    .row.me{ flex-direction:row-reverse }
    .avatar{
      --size: 34px;
      flex:0 0 var(--size); width:var(--size); height:var(--size); border-radius:50%;
      display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(125,211,252,.85), rgba(167,139,250,.85));
      border:1px solid var(--border);
      box-shadow:0 6px 16px rgba(0,0,0,.18);

      /* refined typography */
      font-family: ui-rounded, "SF Pro Rounded", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-size: 12px; font-weight: 600; letter-spacing: .3px;
      color: #0b1020; line-height:1; text-transform: uppercase;
    }
    .bubble{
      max-width:min(78%, 700px);
      padding:14px 16px; border-radius:14px; border:1px solid var(--border);
      background:rgba(255,255,255,.05); box-shadow: 0 6px 18px rgba(0,0,0,.15);
      word-wrap: anywhere;
    }
    .me .bubble{
      background:linear-gradient(135deg, rgba(125,211,252,.18), rgba(167,139,250,.2));
      border-color:rgba(255,255,255,.16);
    }

    /* Assistant message typography + links */
    .bubble h1,.bubble h2,.bubble h3{ margin:0 0 .5rem }
    .bubble p{ margin:.4rem 0 }
    .bubble ul{ margin:.4rem 0 .4rem 1.2rem }
    .bubble a{
      color:#6cbcff;                   /* clean blue */
      text-decoration:none;
      border-bottom:1px dashed rgba(108,188,255,.65);
      font-weight:700;
    }
    .bubble a:hover{
      text-decoration:underline;       /* solid underline on hover */
      border-bottom-color: transparent;
    }

    /* Typing */
    .typing{ display:inline-flex; gap:5px; align-items:center; color:var(--muted); font-size:13px }
    .dot{ width:6px; height:6px; border-radius:50%; background:var(--muted); opacity:.6; animation:pulse 1.2s infinite }
    .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
    @keyframes pulse{ 0%,80%,100%{opacity:.2; transform:translateY(0)} 40%{opacity:1; transform:translateY(-2px)} }

    /* Input bar */
    .input{
      display:flex; gap:10px; padding:12px; border-top:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    }
    .field{ position:relative; flex:1; }
    textarea{
      width:100%; min-height:44px; max-height:160px; resize:none;
      border-radius:14px; padding:12px 44px 12px 14px; color:var(--text);
      background:var(--panel); border:1px solid var(--border); outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    textarea:focus{ border-color:var(--ring); box-shadow:0 0 0 6px var(--ring); background:var(--panel-2) }

    .action{
      position:absolute; right:8px; top:8px; display:flex; gap:6px;
    }
    .icon-btn{
      width:28px; height:28px; display:grid; place-items:center; border-radius:8px;
      border:1px solid var(--border); background:rgba(255,255,255,.04);
      cursor:pointer; transition: transform .08s ease, background .15s ease;
      user-select:none;
    }
    .icon-btn:active{ transform:scale(.98) }

    button.send{
      appearance:none; border:0; cursor:pointer; font-weight:800;
      padding:12px 16px; border-radius:12px; color:#0b1020;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 26px rgba(125,211,252,.18);
      transition:transform .08s ease, opacity .2s ease;
      white-space:nowrap;
    }
    button.send:disabled{ opacity:.6; cursor:not-allowed }
    button.send:hover{ transform:translateY(-1px) }

    /* Scrollbar */
    #messages::-webkit-scrollbar{ width:10px }
    #messages::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.12); border-radius:10px }
    #messages::-webkit-scrollbar-track{ background:transparent }

    /* Mobile */
    @media (max-width:640px){
      .bubble{ max-width:88% }
      .avatar{ --size: 30px; font-size: 11px; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo" aria-hidden>🎓</div>
      <div class="brand">
        <h1>VIFHE Bot</h1>
        <p>Your study companion • Ask questions, get clear answers</p>
      </div>
    </div>
  </header>

  <main class="card" aria-live="polite">
    <div class="card-head">
      <div class="status-dot" aria-hidden></div>
      <div class="muted">Online</div>
    </div>

    <div id="messages"></div>

    <form class="input" id="form" autocomplete="off">
      <div class="field">
        <textarea id="input" placeholder="Type your question…  (Enter to send • Shift+Enter = new line)" aria-label="Message input"></textarea>
        <div class="action">
          <div class="icon-btn" title="Clear" id="clearBtn">✕</div>
        </div>
      </div>
      <button class="send" id="send" type="submit">Send ▸</button>
    </form>
  </main>

  <script>
    const $messages = document.getElementById('messages');
    const $form = document.getElementById('form');
    const $input = document.getElementById('input');
    const $send = document.getElementById('send');
    const $clear = document.getElementById('clearBtn');
    let threadId = null;
    let thinkingRow = null;

    function row(me=false){
      const r = document.createElement('div');
      r.className = 'row' + (me ? ' me' : '');
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = me ? 'YOU' : 'VA';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      r.appendChild(avatar); r.appendChild(bubble);
      $messages.appendChild(r);
      $messages.scrollTop = $messages.scrollHeight;
      return { r, bubble };
    }

    // Adds a message. Assistant messages are rendered as Markdown (clean blue links).
    function addMessage(text, me=false){
      const { bubble } = row(me);
      if (me) {
        bubble.textContent = text; // user stays plain text
      } else {
        const html = DOMPurify.sanitize(marked.parse(text || ''), { USE_PROFILES:{ html:true } });
        bubble.innerHTML = html;
        // safe links
        bubble.querySelectorAll('a').forEach(a => {
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
        });
      }
    }

    function addThinking(){
      const { r, bubble } = row(false);
      bubble.innerHTML = `<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span>&nbsp;Typing…</span>`;
      thinkingRow = r;
    }

    function setSending(state){
      $send.disabled = state;
      $send.textContent = state ? '…' : 'Send ▸';
    }

    async function sendMessage(message){
      setSending(true);
      addThinking();
      try{
        const resp = await fetch('/api/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ message, threadId })
        });
        const data = await resp.json();
        if (thinkingRow) thinkingRow.remove();

        if (!resp.ok){
          addMessage('⚠️ ' + (data.error || 'Request failed'));
          return;
        }
        addMessage(data.reply || '(no reply)');
        threadId = data.responseId || data.threadId || threadId;
      }catch(e){
        if (thinkingRow) thinkingRow.remove();
        addMessage('⚠️ Network error. Please try again.');
      }finally{
        setSending(false);
      }
    }

    // Auto-grow textarea + disable send when empty
    function updateSendState(){
      const hasText = $input.value.trim().length > 0;
      $send.disabled = !hasText;
    }
    $input.addEventListener('input', () => {
      $input.style.height = 'auto';
      $input.style.height = Math.min($input.scrollHeight, 160) + 'px';
      updateSendState();
    });

    // Submit on Enter (Shift+Enter = newline)
    $form.addEventListener('submit', (e) => {
      e.preventDefault();
      const message = $input.value.trim();
      if (!message) return;
      addMessage(message, true);
      $input.value = ''; $input.style.height = '44px'; updateSendState();
      sendMessage(message);
    });
    $input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        $form.requestSubmit();
      }
    });

    // Clear chat
    $clear.addEventListener('click', () => {
      $messages.innerHTML = '';
      threadId = null;
      addMessage("Hi! I'm the VIFHE Bot. How can I help?");
    });

    // Initial state
    updateSendState();
    addMessage("Hi! I'm the VIFHE Bot. How can I help?");
  </script>
</body>
</html>
